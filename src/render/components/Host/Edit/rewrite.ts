import type { FSWatcher, WatchEventType } from 'fs'
import { reactive, markRaw } from 'vue'
import { getAllFileAsync } from '@shared/file'
import { join } from 'path'
import { existsSync, mkdirSync, watch as fsWatch } from 'fs'

type NginxRewriteItem = {
  name: string
  content: string
}

export const HostNginxRewriteSetup: {
  nginxRewriteDefault: Record<string, NginxRewriteItem>
  nginxRewriteCustom: Record<string, NginxRewriteItem>
  fileWatcher: FSWatcher | null
  templateWatcher: FSWatcher | null
  initFileWatch: (file: string, fn: Function) => void
  deinitFileWatch: () => void
  initNginxRewrites: () => void
  deinitNginxRewriteCustomWatch: () => void
  initNginxRewriteCustomWatch: () => void
  save: () => void
} = reactive({
  nginxRewriteDefault: {},
  nginxRewriteCustom: {},
  fileWatcher: null,
  templateWatcher: null,
  deinitNginxRewriteCustomWatch() {
    HostNginxRewriteSetup.templateWatcher && HostNginxRewriteSetup.templateWatcher.close()
    HostNginxRewriteSetup.templateWatcher = null
  },
  initNginxRewriteCustomWatch() {
    HostNginxRewriteSetup.templateWatcher && HostNginxRewriteSetup.templateWatcher.close()
    const dir = join(global.Server.BaseDir!, 'NginxRewriteTemplate')
    HostNginxRewriteSetup.templateWatcher = markRaw(
      fsWatch(
        dir,
        {
          recursive: true
        },
        (event: WatchEventType, filename: string) => {
          console.log('event & filename: ', event, filename)
          if (filename) {
            const file = join(dir, filename)
            const k = filename.split('.').shift()!
            if (existsSync(file)) {
              HostNginxRewriteSetup.nginxRewriteCustom[file] = reactive({
                name: k,
                content: ''
              })
            } else {
              delete HostNginxRewriteSetup.nginxRewriteCustom[file]
            }
          }
        }
      )
    )
  },
  initNginxRewrites() {
    if (Object.keys(HostNginxRewriteSetup.nginxRewriteDefault).length === 0) {
      const dir = join(global.Server.Static!, 'rewrite')
      getAllFileAsync(dir, false).then((files) => {
        files = files.sort()
        for (const file of files) {
          const name = file.replace('.conf', '')
          const k = join(dir, file)
          HostNginxRewriteSetup.nginxRewriteDefault[k] = reactive({
            name,
            content: ''
          })
        }
      })
    }

    if (Object.keys(HostNginxRewriteSetup.nginxRewriteCustom).length === 0) {
      const dir = join(global.Server.BaseDir!, 'NginxRewriteTemplate')
      mkdirSync(dir, { recursive: true })
      getAllFileAsync(dir, false).then((files) => {
        files = files.sort()
        for (const file of files) {
          const k = join(dir, file)
          if (!existsSync(k)) {
            continue
          }
          const name = file.split('.').shift()!
          HostNginxRewriteSetup.nginxRewriteCustom[k] = {
            name,
            content: ''
          }
        }
      })
    }
  },
  initFileWatch(file: string, fn: Function) {
    HostNginxRewriteSetup.fileWatcher && HostNginxRewriteSetup.fileWatcher.close()
    HostNginxRewriteSetup.fileWatcher = markRaw(fsWatch(file, fn))
  },
  deinitFileWatch() {
    HostNginxRewriteSetup.fileWatcher && HostNginxRewriteSetup.fileWatcher.close()
    HostNginxRewriteSetup.fileWatcher = null
  },
  save() {}
})
